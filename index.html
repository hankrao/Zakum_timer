<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç‚é­”è¨ˆæ™‚å™¨ï½œæ™‚é–“é­”æ–¹</title>
  <!-- PWA / iOS ä¸»ç•«é¢æ”¯æ´ -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="ç‚é­”è¨ˆæ™‚å™¨" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <link rel="icon" sizes="192x192" href="./icon-192.png" />
  <link rel="icon" sizes="512x512" href="./icon-512.png" />

  <style>
    :root{
      --bg:#0b1220; --card:#121b2f; --text:#e9eefc; --muted:#9fb0d0;
      --accent:#4f8cff; --good:#25d366; --danger:#ff4d4d;
      --border: rgba(255,255,255,.12);
    }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 0%, #122043, var(--bg));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .page{ width:min(820px, 100%); }
    .header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin: 0 0 14px;
    }
    .header h1{ margin:0; font-size:20px; color:#dbe7ff; letter-spacing:.6px; }
    .headerRight{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .stack{ display:grid; gap:14px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .titleRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin:0 0 6px;
    }
    .titleRow h2{ margin:0; font-size:16px; color:#dbe7ff; letter-spacing:.3px; }
    .badge{ font-size:12px; color:rgba(233,238,252,.8); opacity:.85; }

    .timer{
      font-variant-numeric: tabular-nums;
      font-size:72px; font-weight:800; letter-spacing:1px;
      margin:10px 0 12px;
    }
    .sub{ display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:13px; }
    .pill{
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(0,0,0,.18);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:13px; color:var(--muted); }
    input[type="number"], input[type="text"]{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none; max-width: 360px; }
    input[type="number"]{ width:88px; }
    input[type="text"]{ width: min(340px, 100%); flex: 1; }
    input[type="range"]{ width:180px; accent-color: var(--accent); }
    .volNum{ width:72px !important; }
    input:focus{ border-color: rgba(79,140,255,.65); }

    button{
      border:none; border-radius:12px; padding:10px 12px;
      background: rgba(255,255,255,.10);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      transition: transform .05s ease, background .2s ease, opacity .2s ease;
    }
    button:hover{ background: rgba(255,255,255,.14); }
    button:active{ transform: translateY(1px); }
    .primary{ background: rgba(79,140,255,.85); }
    .primary:hover{ background: rgba(79,140,255,.95); }
    .good{ background: rgba(37,211,102,.82); }
    .good:hover{ background: rgba(37,211,102,.92); }
    .danger{ background: rgba(255,77,77,.80); }
    .danger:hover{ background: rgba(255,77,77,.92); }

    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      user-select:none;
    }
    .toggle input{ transform: scale(1.1); }

    .toast{
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      min-width: 260px;
      max-width: min(920px, calc(100vw - 32px));
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(18, 27, 47, .92);
      color: #e9eefc;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(4px); }
    .toast small{
      display:block; margin-top:6px;
      font-weight:650; color: rgba(233,238,252,.78);
      line-height: 1.35;
    }

    .divider{ height:1px; background: rgba(255,255,255,.10); margin:14px 0 10px; border-radius: 1px; }
    .noteLine{ margin-top:6px; font-size:12px; color: rgba(233,238,252,.70); line-height: 1.35; }

    .log{
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      min-height:140px;
      color:#dbe7ff;
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    .btnWide{ width:auto; min-width: 220px; max-width: 320px; justify-content:center; }
  .btnWide{ display:inline-flex; }
  .btnWideWrap{ display:flex; justify-content:flex-start; }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <div class="page">
    <div class="header">
      <h1>ç‚é­”è¨ˆæ™‚å™¨</h1>
      <div class="headerRight">
        <button class="primary" id="miniModeBtn">å°çª—æ¨¡å¼</button>
        <button class="primary" id="restoreDefaultsBtn">æ¢å¾©é è¨­å€¼</button>
      </div>
    </div>

    <!-- ===================== Timer A ===================== -->
    <section class="stack" id="timerA">
      <div class="card">
        <div class="titleRow">
          <h2>Timer Aï½œæ™‚é–“é­”æ–¹è¨ˆæ™‚å™¨</h2>
          <div class="badge">åˆ°æé†’æ™‚é»ï¼Œç™¼å‡ºèªéŸ³æé†’ï¼›æ™‚é–“æ­¸é›¶å¾Œè‡ªå‹•åˆ·æ–°</div>
        </div>

        <div data-a="display" class="timer">02:30</div>

        <div class="sub">
          <div class="pill">ç‹€æ…‹ï¼š<b data-a="state">å¾…æ©Ÿ</b></div>
          <div class="pill">å¾ªç’°æ™‚é–“ï¼š<b data-a="cycleLabel">02:30</b></div>
          <div class="pill">æå‰é€šçŸ¥ï¼š<b data-a="leadLabel">é–‹ï¼ˆæå‰ 10 ç§’ï¼‰</b></div>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="primary bigBtn" data-a="startBtn">é–‹å§‹</button>
          <button class="danger bigBtn" data-a="resetBtn">åœæ­¢</button>
          <button class="good bigBtn" data-a="recalcBtn">åˆ·æ–°</button>
        </div>

        <div class="noteLine">â€» è‹¥æ™‚é–“æœ‰è½å·®ï¼Œå‡ºç¾é­”æ–¹æ™‚é»æ“Šã€Œåˆ·æ–°ã€</div>
      </div>

      <div class="card">
        <div class="titleRow">
          <h2>Timer Aï½œè¨­å®š</h2>
          <div class="badge">ä¸€éµå¥—ç”¨å…¨éƒ¨è¨­å®š</div>
        </div>

        <div class="row" style="margin-top:8px">
          <label>å¾ªç’°æ™‚é–“</label>
          <input type="number" data-a="cycleMin" value="2" min="0" step="1" />
          <label>åˆ†</label>
          <input type="number" data-a="cycleSec" value="30" min="0" max="59" step="1" />
          <label>ç§’</label>
        </div>

        <div class="row" style="margin-top:14px">
          <label>æé†’å…§å®¹</label>
          <input type="text" data-a="mainText" value="é­”æ–¹å€’æ•¸!" />
        </div>

        <div class="row" style="margin-top:14px">
          <div class="toggle">
            <input type="checkbox" data-a="leadEnabled" checked />
            <label style="color:#dbe7ff">å•Ÿç”¨æå‰é€šçŸ¥</label>
          </div>
          <label>æå‰</label>
          <input type="number" data-a="leadSeconds" value="10" min="0" step="1" />
          <label>ç§’</label>
        </div>

        <div class="row btnWideWrap" style="margin-top:14px">
          <button class="primary btnWide" data-a="applyAllBtn">âœ… å¥—ç”¨å…¨éƒ¨è¨­å®š</button>
        </div>
      </div>

      <section class="stack" id="globalSettings" style="margin: 0 0 14px">
      <div class="card">
        <div class="titleRow">
          <h2>Timer Aï½œèªéŸ³</h2>
          <div class="badge">æé†’é€šçŸ¥èªéŸ³è¨­å®š</div>
        </div>

        <div class="row" style="margin-top:10px"> 
 <button id="globalTestVoiceBtn">ğŸ”Š æ¸¬è©¦èªéŸ³</button> 
 <label>éŸ³é‡</label> 
 <input type="range" id="globalVolRange" min="0" max="100" step="1" value="100" /> 
 <input class="volNum" type="number" id="globalVolNum" min="0" max="100" step="1" value="100" /> 
</div>

        <div class="row" style="margin-top:10px">
          <label>èªé€Ÿ</label>
          <input type="number" id="globalVoiceRate" value="1.10" min="0.6" max="1.6" step="0.05" />
          <label>éŸ³é«˜</label>
          <input type="number" id="globalVoicePitch" value="1.00" min="0.6" max="1.6" step="0.05" />
        </div>
      </div>
    </section>
<div class="card">
        <div class="titleRow">
          <h2>Timer Aï½œè¨Šæ¯</h2>
          <div class="badge">æœ€è¿‘ 10 ç­†</div>
        </div>
        <div class="log" id="logA"></div>
      </div>
    </section>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // -------------------- Toast --------------------
  const toast = document.getElementById('toast');
  let toastTimer = null;
  function showToast(title, sub=''){
    toast.innerHTML = `${title}${sub ? `<small>${sub}</small>` : ''}`;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove('show'), 2400);

    // Mini window toast (if any)
    try{
      if (miniWin && !miniWin.closed){
        const mt = miniWin.document.getElementById('miniToast');
        if (mt){
          mt.innerHTML = `${title}${sub ? `<small>${sub}</small>` : ''}`;
          mt.classList.add('show');
          clearTimeout(miniToastTimer);
          miniToastTimer = setTimeout(() => { try{ mt.classList.remove('show'); }catch(e){} }, 2400);
        }
      }
    }catch(e){}
  }

  // -------------------- Logs --------------------
  const MAX_LOGS = 10;
  const logAEl = document.getElementById('logA');
  const logBuffer = new WeakMap();
  function pushLog(el, msg){
    const t = new Date().toLocaleTimeString();
    const line = `[${t}] ${msg}`;
    const arr = logBuffer.get(el) || [];
    arr.unshift(line);
    if (arr.length > MAX_LOGS) arr.length = MAX_LOGS;
    logBuffer.set(el, arr);
    el.textContent = arr.join('\n');
  }
  pushLog(logAEl, 'è¼‰å…¥å®Œæˆã€‚');

  // -------------------- Utils --------------------
  const pad2 = (n) => String(n).padStart(2,'0');
  const fmtFloor = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60), s = sec%60;
    return `${pad2(m)}:${pad2(s)}`;
  };
  const fmtCountdown = (sec) => {
    sec = Math.max(0, sec);
    const rounded = (sec > 0) ? Math.ceil(sec) : 0;
    const m = Math.floor(rounded/60), s = rounded%60;
    return `${pad2(m)}:${pad2(s)}`;
  };
  const now = () => performance.now();

  // -------------------- Storage keys --------------------
  // ä¿ç•™èˆ‡èˆŠç‰ˆç›¸å®¹ï¼šTimer A v2 & Global voice v1
  const KEY_TIMER_A = 'yanmo_newtool_timerA_cycle_settings_v1';
  const KEY_GLOBAL_VOICE = 'yanmo_newtool_global_voice_settings_v1';

  // -------------------- TTS --------------------
  let selectedVoice = null;
  function pickChineseVoice(){
    const voices = window.speechSynthesis?.getVoices?.() || [];
    if (!voices.length) return null;
    let v = voices.find(v => (v.lang||'').toLowerCase() === 'zh-tw');
    if (v) return v;
    v = voices.find(v => (v.lang||'').toLowerCase().startsWith('zh'));
    if (v) return v;
    return voices[0] || null;
  }
  function initVoices(){
    if (!window.speechSynthesis) return;
    selectedVoice = pickChineseVoice();
    window.speechSynthesis.onvoiceschanged = () => { selectedVoice = pickChineseVoice(); };
  }
  initVoices();

 // ===== Mobile Safari/Chrome å…¼å®¹ï¼šèªéŸ³å¼•æ“é ç†± & voices è¼‰å…¥ç­‰å¾… =====
 let speechPrimed = false;
 let voicesReady = false;
 let voicesReadyPromise = null;

 function ensureVoicesReady(timeoutMs = 2000){
   if (!window.speechSynthesis) return Promise.resolve(false);
   if (voicesReady) return Promise.resolve(true);
   if (voicesReadyPromise) return voicesReadyPromise;

   voicesReadyPromise = new Promise(resolve => {
     const synth = window.speechSynthesis;
     const start = Date.now();

     const check = () => {
       try {
         const vs = synth.getVoices?.() || [];
         if (vs.length){
           voicesReady = true;
           try { selectedVoice = pickChineseVoice(); } catch(e) {}
           cleanup();
           return resolve(true);
         }
       } catch(e) {}
       if (Date.now() - start >= timeoutMs){
         cleanup();
         return resolve(false);
       }
       setTimeout(check, 120);
     };

     const onChanged = () => {
       try {
         const vs = synth.getVoices?.() || [];
         if (vs.length){
           voicesReady = true;
           try { selectedVoice = pickChineseVoice(); } catch(e) {}
           cleanup();
           return resolve(true);
         }
       } catch(e) {}
     };

     function cleanup(){
       try { synth.removeEventListener('voiceschanged', onChanged); } catch(e) {}
       voicesReadyPromise = null;
     }

     try { synth.addEventListener('voiceschanged', onChanged); } catch(e) {}
     // å…ˆè§¸ç™¼ä¸€æ¬¡ voices å–å¾—ï¼ˆSafari å¸¸éœ€è¦å…ˆå‘¼å«æ‰é–‹å§‹è¼‰å…¥ï¼‰
     try { synth.getVoices?.(); } catch(e) {}
     check();
   });

   return voicesReadyPromise;
 }

 async function primeSpeech(){
   // iOS Safari å¸¸éœ€è¦åœ¨ä½¿ç”¨è€…æ‰‹å‹¢ä¸‹å…ˆã€Œå–šé†’ã€éŸ³è¨Š/èªéŸ³ï¼Œå¾ŒçºŒ timer è§¸ç™¼æ‰æ›´ç©©
   if (speechPrimed) return true;
   if (!window.speechSynthesis) return false;
   try {
     await ensureVoicesReady(2500);
     window.speechSynthesis.cancel();
     const u = new SpeechSynthesisUtterance('');
     u.lang = 'zh-TW';
     u.volume = 0; // éœéŸ³é ç†±
     u.rate = 1;
     u.pitch = 1;
     window.speechSynthesis.speak(u);
     speechPrimed = true;
     return true;
   } catch(e){
     return false;
   }
 }


  function speak(text){
    const t = (text||'').trim();
    if (!t) return;
    const conf = window.__YANMO_VOICE__ || { rate:1.1, pitch:1.0, volume:100 };
    if (!window.speechSynthesis){
      showToast('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€', 'å»ºè­°ä½¿ç”¨ Chrome/Edge');
      return;
    }
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(t);
      u.lang = 'zh-TW';
      const r = Number(conf.rate), p = Number(conf.pitch), v = Number(conf.volume);
      u.rate = Number.isFinite(r) ? Math.min(1.6, Math.max(0.6, r)) : 1.1;
      u.pitch = Number.isFinite(p) ? Math.min(1.6, Math.max(0.6, p)) : 1.0;
      u.volume = Number.isFinite(v) ? Math.min(1, Math.max(0, v/100)) : 1.0;
      if (selectedVoice) u.voice = selectedVoice;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // -------------------- Global Voice Settings --------------------
  const gvRateEl = document.getElementById('globalVoiceRate');
  const gvPitchEl = document.getElementById('globalVoicePitch');
  const gvVolRangeEl = document.getElementById('globalVolRange');
  const gvVolNumEl = document.getElementById('globalVolNum');
  const gvTestBtn = document.getElementById('globalTestVoiceBtn');
  function clampVol100(v){ v = Number(v); if (!Number.isFinite(v)) return 100; return Math.min(100, Math.max(0, Math.round(v))); }
  function clampRatePitch(v){ v = Number(v); if (!Number.isFinite(v)) return null; return Math.min(1.6, Math.max(0.6, v)); }

  function saveGlobalVoice(){
    try{
      const payload = {
        rate: clampRatePitch(gvRateEl?.value) ?? 1.1,
        pitch: clampRatePitch(gvPitchEl?.value) ?? 1.0,
        volume: clampVol100(gvVolNumEl?.value ?? gvVolRangeEl?.value)
      };
      localStorage.setItem(KEY_GLOBAL_VOICE, JSON.stringify(payload));
    }catch(e){}
  }

  function applyGlobalVoice(payload, save=false){
    const rate = Number.isFinite(payload?.rate) ? Math.min(1.6, Math.max(0.6, payload.rate)) : 1.1;
    const pitch = Number.isFinite(payload?.pitch) ? Math.min(1.6, Math.max(0.6, payload.pitch)) : 1.0;
    const vol = clampVol100(payload?.volume);
    if (gvRateEl) gvRateEl.value = String(rate);
    if (gvPitchEl) gvPitchEl.value = String(pitch);
    if (gvVolRangeEl) gvVolRangeEl.value = String(vol);
    if (gvVolNumEl) gvVolNumEl.value = String(vol);
    window.__YANMO_VOICE__ = { rate, pitch, volume: vol };
    if (save) saveGlobalVoice();
  }

  // Load saved voice (with backward compat for older volume-only key)
  (function(){
    let payload = null;
    try{
      const raw = localStorage.getItem(KEY_GLOBAL_VOICE);
      if (raw) payload = JSON.parse(raw);
    }catch(e){}
    applyGlobalVoice(payload || { rate:1.1, pitch:1.0, volume:100 }, false);
  })();

  function syncVol(from){
    const v = clampVol100(from);
    if (gvVolRangeEl) gvVolRangeEl.value = String(v);
    if (gvVolNumEl) gvVolNumEl.value = String(v);
    window.__YANMO_VOICE__ = {
      rate: clampRatePitch(gvRateEl?.value) ?? 1.1,
      pitch: clampRatePitch(gvPitchEl?.value) ?? 1.0,
      volume: v
    };
    saveGlobalVoice();
  }

  if (gvVolRangeEl){
    gvVolRangeEl.addEventListener('input', () => syncVol(gvVolRangeEl.value));
    gvVolRangeEl.addEventListener('change', () => syncVol(gvVolRangeEl.value));
  }
  if (gvVolNumEl){
    gvVolNumEl.addEventListener('input', () => syncVol(gvVolNumEl.value));
    gvVolNumEl.addEventListener('change', () => syncVol(gvVolNumEl.value));
  }
  [gvRateEl, gvPitchEl].forEach(el => {
    if (!el) return;
    el.addEventListener('change', () => applyGlobalVoice({
      rate: clampRatePitch(gvRateEl?.value) ?? 1.1,
      pitch: clampRatePitch(gvPitchEl?.value) ?? 1.0,
      volume: clampVol100(gvVolNumEl?.value ?? gvVolRangeEl?.value)
    }, true));
  });
  if (gvTestBtn){
    gvTestBtn.addEventListener('click', async () => {
 initVoices();
 await primeSpeech();
 const mainTextEl = document.querySelector('[data-a=\"mainText\"]');
 const text = (mainTextEl?.value || '').trim() || 'é­”æ–¹å€’æ•¸!';
 showToast('ğŸ”Š æ¸¬è©¦èªéŸ³', text);
 pushLog(logAEl, 'åŸ·è¡Œå…¨åŸŸèªéŸ³æ¸¬è©¦');
 speak(text, { userGesture: true });
 });
  }

  // -------------------- Restore defaults --------------------
  document.getElementById('restoreDefaultsBtn').addEventListener('click', () => {
    try{
      localStorage.removeItem(KEY_TIMER_A);
      localStorage.removeItem(KEY_GLOBAL_VOICE);
    }catch(e){}
    showToast('âœ… å·²æ¢å¾©é è¨­å€¼', 'å³å°‡é‡æ–°è¼‰å…¥...');
    setTimeout(() => location.reload(), 350);
  });

  // -------------------- API (for mini window) --------------------
  const API = { timerA: null };
  window.__YANMO_API = API;

  // -------------------- Mini window (Document PiP) --------------------
  let miniWin = null;
  let miniUpdateTimer = null;
  let miniToastTimer = null;

  function isDocPiPSupported(){
    return !!window.documentPictureInPicture && typeof window.documentPictureInPicture.requestWindow === 'function';
  }
  function stopMiniUpdater(){
    if (miniUpdateTimer){ clearInterval(miniUpdateTimer); miniUpdateTimer = null; }
  }
  function closeMiniWindow(){
    stopMiniUpdater();
    if (miniToastTimer){ clearTimeout(miniToastTimer); miniToastTimer = null; }
    try{ miniWin?.close?.(); }catch(e){}
    miniWin = null;
    document.getElementById('miniModeBtn').textContent = 'å°çª—æ¨¡å¼';
  }

  async function openMiniWindow(){
    if (!API.timerA){
      showToast('âš ï¸ å°šæœªåˆå§‹åŒ–å®Œæˆ', 'è«‹ç¨å¾Œå†è©¦ä¸€æ¬¡');
      return;
    }
    if (miniWin && !miniWin.closed){
      closeMiniWindow();
      return;
    }
    if (!isDocPiPSupported()){
      showToast('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å°çª—ç½®é ‚', 'è«‹ç”¨ Chrome/Edge æ¡Œé¢ç‰ˆ');
      pushLog(logAEl, 'âš ï¸ å°çª—æ¨¡å¼å•Ÿå‹•å¤±æ•—ï¼šä¸æ”¯æ´ documentPictureInPicture');
      return;
    }

    try{
      miniWin = await window.documentPictureInPicture.requestWindow({ width: 360, height: 170 });
      document.getElementById('miniModeBtn').textContent = 'é—œé–‰å°çª—';
    }catch(e){
      showToast('å°çª—æ¨¡å¼å•Ÿå‹•å¤±æ•—', 'è«‹ç¢ºèªç€è¦½å™¨å…è¨±ï¼ˆéœ€ä½¿ç”¨è€…é»æ“Šè§¸ç™¼ï¼‰');
      return;
    }

    const d = miniWin.document;
    d.title = 'ç‚é­”è¨ˆæ™‚å™¨ï½œå°çª—ï¼ˆTimer Aï¼‰';
    d.body.style.margin = '0';
    d.body.style.background = '#0b1220';
    d.body.style.color = '#e9eefc';
    d.body.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Arial';
    d.body.style.userSelect = 'none';

    const style = d.createElement('style');
    style.textContent = `
      .wrap{ padding:10px; display:grid; gap:10px; }
      .card{ border:1px solid rgba(255,255,255,.14); background: rgba(18,27,47,.82); border-radius:12px; padding:10px; }
      .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
      .title{ font-size:12px; opacity:.9; font-weight:900; letter-spacing:.2px; }
      .time{ font-variant-numeric: tabular-nums; font-size:34px; font-weight:950; letter-spacing:1px; }
      .btns{ display:flex; gap:6px; flex-wrap:wrap; }
      button{ border:none; border-radius:10px; padding:8px 10px; background: rgba(255,255,255,.10); color:#e9eefc; font-weight:900; cursor:pointer; }
      button:hover{ background: rgba(255,255,255,.14); }
      .good{ background: rgba(37,211,102,.75); }
      .good:hover{ background: rgba(37,211,102,.86); }
      .danger{ background: rgba(255,77,77,.75); }
      .danger:hover{ background: rgba(255,77,77,.86); }
      .primary{ background: rgba(79,140,255,.80); }
      .primary:hover{ background: rgba(79,140,255,.92); }
      .hint{ font-size:11px; opacity:.75; margin-top:4px; line-height:1.2; }
      .toast{ position:fixed; left:50%; top:10px; transform:translateX(-50%);
        min-width: 220px; max-width: calc(100vw - 20px);
        padding:10px 12px; border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background: rgba(18,27,47,.92);
        color:#e9eefc; box-shadow:0 14px 40px rgba(0,0,0,.35);
        opacity:0; pointer-events:none;
        transition: opacity .18s ease, transform .18s ease;
        font-weight:950; letter-spacing:.2px; z-index:9999;
      }
      .toast.show{ opacity:1; transform:translateX(-50%) translateY(4px); }
      .toast small{ display:block; margin-top:4px; font-weight:700; color:rgba(233,238,252,.78); line-height:1.25; }
    `;
    d.head.appendChild(style);

    const wrap = d.createElement('div');
    wrap.className = 'wrap';

    const cardA = d.createElement('div');
    cardA.className = 'card';
    cardA.innerHTML = `
      <div class="row">
        <div class="title">Aï½œæ™‚é–“é­”æ–¹</div>
        <div class="time" id="timeA">00:00</div>
      </div>
      <div class="row">
        <div class="btns">
          <button class="primary" id="aStart">é–‹å§‹</button>
          <button class="primary" id="aCalib">åˆ·æ–°</button>
          <button class="danger" id="aReset">åœæ­¢</button>
        </div>
      </div>
      <div class="hint" id="hintA"></div>
    `;
    wrap.appendChild(cardA);
    d.body.appendChild(wrap);

    const miniToast = d.createElement('div');
    miniToast.className = 'toast';
    miniToast.id = 'miniToast';
    d.body.appendChild(miniToast);

    d.getElementById('aStart').addEventListener('click', () => API.timerA.start());
    d.getElementById('aCalib').addEventListener('click', () => API.timerA.calibrate());
    d.getElementById('aReset').addEventListener('click', () => API.timerA.reset());

    miniWin.addEventListener('pagehide', () => closeMiniWindow());

    stopMiniUpdater();
    miniUpdateTimer = setInterval(() => {
      if (!miniWin || miniWin.closed){ closeMiniWindow(); return; }
      try{
        miniWin.document.getElementById('timeA').textContent = fmtCountdown(API.timerA.getRemaining());
        miniWin.document.getElementById('hintA').textContent = API.timerA.getStateLabel();
      }catch(e){}
    }, 200);
  }

  document.getElementById('miniModeBtn').addEventListener('click', openMiniWindow);

  // -------------------- Timer A (cycle) --------------------
  (function initTimerA(){
    const root = document.getElementById('timerA');
    const $ = (key) => {
      const el = root.querySelector(`[data-a="${key}"]`);
      if (!el) throw new Error(`Timer A ç¼ºå°‘ data-a="${key}" å…ƒç´ `);
      return el;
    };

    const display = $('display');
    const stateEl = $('state');
    const cycleLabel = $('cycleLabel');
    const leadLabel = $('leadLabel');
    const startBtn = $('startBtn');
    const resetBtn = $('resetBtn');
    const recalcBtn = $('recalcBtn');

    const cycleMin = $('cycleMin');
    const cycleSec = $('cycleSec');
    const mainTextInput = $('mainText');
    const leadEnabled = $('leadEnabled');
    const leadSecondsInput = $('leadSeconds');
    const applyAllBtn = $('applyAllBtn');

    const save = (obj) => { try{ localStorage.setItem(KEY_TIMER_A, JSON.stringify(obj)); }catch(e){} };
    const load = () => { try{ const r = localStorage.getItem(KEY_TIMER_A); return r ? JSON.parse(r) : null; }catch(e){ return null; } };

    // Defaults (02:30)
    let cycleSeconds = 2*60 + 30;
    let mainText = 'é­”æ–¹å€’æ•¸!';
    let leadOn = true;
    let leadSeconds = 10;

    let running = false;
    let endAt = null;
    let pausedRemaining = cycleSeconds;
    let firedThisCycle = false;
    let lastRemaining = null;

    const setState = (s) => stateEl.textContent = s;

    function normalize(){
      cycleSeconds = Math.max(1, Math.floor(cycleSeconds));
      leadSeconds = Math.max(0, Math.floor(leadSeconds));
      if (cycleSeconds > 1 && leadSeconds >= cycleSeconds){
        leadSeconds = cycleSeconds - 1;
        leadSecondsInput.value = leadSeconds;
        pushLog(logAEl, `æå‰ç§’æ•¸éå¤§ï¼Œå·²è‡ªå‹•èª¿æ•´ç‚º ${leadSeconds} ç§’ï¼ˆå¾ªç’°æ™‚é–“ - 1 ç§’ï¼‰`);
      }
    }

    function updateLabels(){
      cycleLabel.textContent = fmtFloor(cycleSeconds);
      leadLabel.textContent = leadOn ? `é–‹ï¼ˆæå‰ ${leadSeconds} ç§’ï¼‰` : 'é—œ';
    }

    function getRemaining(){
      const t = now();
      if (running && endAt) return Math.max(0, (endAt - t)/1000);
      return pausedRemaining;
    }

    function render(){
      display.textContent = fmtCountdown(getRemaining());
      updateLabels();
    }

    function saveAll(){
      save({ cycleSeconds, mainText, leadOn, leadSeconds });
    }

    function resetFlags(){
      firedThisCycle = false;
      lastRemaining = cycleSeconds + 0.5;
    }

    function applyAllSettings(){
      const cm = Math.max(0, parseInt(cycleMin.value || '0', 10));
      const csRaw = parseInt(cycleSec.value || '0', 10);
      const cs = Math.min(59, Math.max(0, isNaN(csRaw) ? 0 : csRaw));
      cycleSec.value = cs;

      cycleSeconds = Math.max(1, cm*60 + cs);
      mainText = (mainTextInput.value || '').trim() || 'é­”æ–¹å€’æ•¸!';
      mainTextInput.value = mainText;

      leadOn = !!leadEnabled.checked;
      leadSeconds = Math.max(0, parseInt(leadSecondsInput.value || '0', 10));

      normalize();
      if (!running) pausedRemaining = cycleSeconds;
      firedThisCycle = false;
      lastRemaining = null;

      saveAll();
      showToast('âœ… Timer A å·²å¥—ç”¨è¨­å®š', `å¾ªç’° ${fmtFloor(cycleSeconds)}ï½œæå‰ ${leadOn ? (leadSeconds+'ç§’') : 'é—œ'}`);
      pushLog(logAEl, 'âœ… å·²å¥—ç”¨è¨­å®š');
      render();
    }

    function start(){
      if (running) return;
      const t = now();
      running = true;
      endAt = t + pausedRemaining*1000;
      resetFlags();
      setState('é€²è¡Œä¸­');
      pushLog(logAEl, 'é–‹å§‹å¾ªç’° âœ…');
    }

    function reset(){
      running = false;
      endAt = null;
      pausedRemaining = cycleSeconds;
      resetFlags();
      setState('å¾…æ©Ÿ');
      pushLog(logAEl, 'å·²é‡ç½® âœ…');
      render();
    }

    // refresh current cycle to full length; keep running if running
    function recalc(){
      const t = now();
      pausedRemaining = cycleSeconds;
      resetFlags();
      if (running){
        endAt = t + cycleSeconds*1000;
        setState('é€²è¡Œä¸­');
        pushLog(logAEl, 'åˆ·æ–°ï¼šå·²é‡è¨­æœ¬è¼ªä¸¦ç¹¼çºŒ âœ…');
      }else{
        endAt = null;
        setState('å¾…æ©Ÿ');
        pushLog(logAEl, 'åˆ·æ–°ï¼šå·²é‡è¨­æœ¬è¼ªï¼ˆå°šæœªé–‹å§‹ï¼‰');
      }
      render();
    }

    function calibrate(){ recalc(); }

    // Bind UI
    startBtn.addEventListener('click', async () => { await primeSpeech(); start(); });
    resetBtn.addEventListener('click', reset);
    recalcBtn.addEventListener('click', calibrate);
    applyAllBtn.addEventListener('click', applyAllSettings);

    [cycleMin, cycleSec, mainTextInput, leadSecondsInput].forEach(el => {
      el.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyAllSettings(); });
    });

    leadEnabled.addEventListener('change', () => {
      leadOn = !!leadEnabled.checked;
      updateLabels();
      saveAll();
    });

    // Load saved
    const saved = load();
    if (saved){
      if (Number.isFinite(saved.cycleSeconds)) cycleSeconds = Math.max(1, Math.floor(saved.cycleSeconds));
      if (typeof saved.mainText === 'string') mainText = saved.mainText.trim() || mainText;
      if (typeof saved.leadOn === 'boolean') leadOn = saved.leadOn;
      if (Number.isFinite(saved.leadSeconds)) leadSeconds = Math.max(0, Math.floor(saved.leadSeconds));
    }

    normalize();

    // Apply to UI
    cycleMin.value = Math.floor(cycleSeconds/60);
    cycleSec.value = cycleSeconds%60;
    mainTextInput.value = mainText;
    leadEnabled.checked = leadOn;
    leadSecondsInput.value = leadSeconds;

    pausedRemaining = cycleSeconds;
    setState('å¾…æ©Ÿ');
    resetFlags();
    render();

    // Expose API
    API.timerA = {
      getRemaining,
      start,
      reset,
      recalc,
      calibrate,
      getStateLabel: () => `${stateEl.textContent}ï½œæå‰:${leadOn ? (leadSeconds+'s') : 'é—œ'}`
    };

    function tick(){
      const t = now();
      if (running && endAt){
        const remaining = Math.max(0, (endAt - t)/1000);
        const trigger = (leadOn ? leadSeconds : null);

        if (!firedThisCycle && trigger !== null){
          if (trigger === 0){
            if (remaining <= 0.02){
              firedThisCycle = true;
              speak(mainText, { userGesture: false });
              showToast('â±ï¸ æé†’é€šçŸ¥', mainText);
              pushLog(logAEl, `æé†’ï¼š${mainText} \n æ™‚é–“ 00:00`);
            }
          }else{
            if (lastRemaining != null && lastRemaining > trigger && remaining <= trigger){
              firedThisCycle = true;
              speak(mainText, { userGesture: false });
              showToast('â±ï¸ æé†’é€šçŸ¥', mainText);
              pushLog(logAEl, `æé†’ï¼š${mainText} \nï¼ˆæå‰ ${trigger} ç§’ï¼‰`);
            }
          }
        }

        // auto loop
        if (t >= endAt){
          endAt = t + cycleSeconds*1000;
          pausedRemaining = cycleSeconds;
          resetFlags();
          setState('é€²è¡Œä¸­');
          updateLabels();
        }

        lastRemaining = remaining;
      }

      render();
      requestAnimationFrame(tick);
    }

    requestAnimationFrame(tick);
  })();
});
</script>

<script>
  // PWA é›¢ç·šï¼šè¨»å†Š Service Workerï¼ˆéœ€ HTTPS / localhostï¼‰
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    });
  }
</script>
</body>
</html>
